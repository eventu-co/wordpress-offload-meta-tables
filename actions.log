START TRANSACTION
> OK
> Time: 0.177s


SET
    @fecha_inicial = '2023-10-01'
> OK
> Time: 0.177s


/**
 *
 * BORRAMOS TODOS LOS TICKERA CHECKINS DE LA BASE DE DATOS
 *
 **/
DELETE P,
PM
FROM
    wp_posts AS P
    INNER JOIN wp_postmeta AS PM ON P.ID = PM.post_id
WHERE
    P.post_type = 'tc_tickets_instances'
    AND PM.meta_key = 'tc_checkins'
> Affected rows: 0
> Time: 0.175s


/**********************************
 *
 *          ORPHAN DATA
 *˚
 **********************************/
DROP TABLE IF EXISTS wp_posts_orphan
> OK
> Time: 0.179s


CREATE TABLE wp_posts_orphan LIKE wp_posts
> OK
> Time: 0.183s


DROP TABLE IF EXISTS wp_postmeta_orphan
> OK
> Time: 0.178s


CREATE TABLE wp_postmeta_orphan LIKE wp_postmeta
> OK
> Time: 0.181s


DROP TABLE IF EXISTS wp_comments_orphan
> OK
> Time: 0.183s


CREATE TABLE wp_comments_orphan LIKE wp_comments
> OK
> Time: 0.187s


/* wp_postmeta -> wp_postmeta_orphan */
INSERT
    wp_postmeta_orphan
SELECT
    PM.*
FROM
    wp_postmeta PM
    LEFT JOIN wp_posts P ON PM.post_id = P.ID
WHERE
    P.ID IS NULL
> Affected rows: 0
> Time: 3.617s


DELETE PM
FROM
    wp_postmeta PM
    LEFT JOIN wp_posts P ON PM.post_id = P.ID
WHERE
    P.ID IS NULL
> Affected rows: 0
> Time: 3.993s


/** wp_comments -> wp_comments_orphan */
INSERT
    wp_comments_orphan
SELECT
    C.*
FROM
    wp_comments C
    LEFT JOIN wp_posts P ON C.comment_post_ID = P.ID
WHERE
    P.ID IS NULL
> Affected rows: 0
> Time: 0.511s


--
DELETE C
FROM
    wp_comments C
    LEFT JOIN wp_posts P ON C.comment_post_ID = P.ID
WHERE
    P.ID IS NULL
> Affected rows: 0
> Time: 0.440s


/** wp_posts.post_parent -> wp_posts_orphan */
INSERT
    wp_posts_orphan
SELECT
    P.*
FROM
    wp_posts AS P
    LEFT JOIN wp_posts AS PP ON P.post_parent = PP.ID
WHERE
    PP.ID IS NULL
    AND (
        P.post_parent <> 0
        AND P.post_parent IS NOT NULL
    )
> Affected rows: 0
> Time: 0.435s


DELETE P
FROM
    wp_posts AS P
    LEFT JOIN wp_posts AS PP ON P.post_parent = PP.ID
WHERE
    PP.ID IS NULL
    AND (
        P.post_parent <> 0
        AND P.post_parent IS NOT NULL
    )
> Affected rows: 0
> Time: 0.594s


/**********************************
 *
 *          HISTORIC DATA
 *˚
 **********************************/
DROP TABLE IF EXISTS wp_posts_history
> OK
> Time: 0.142s


CREATE TABLE wp_posts_history LIKE wp_posts
> OK
> Time: 0.185s


DROP TABLE IF EXISTS wp_postmeta_history
> OK
> Time: 0.179s


CREATE TABLE wp_postmeta_history LIKE wp_postmeta
> OK
> Time: 0.182s


DROP TABLE IF EXISTS wp_comments_history
> OK
> Time: 0.179s


CREATE TABLE wp_comments_history LIKE wp_comments
> OK
> Time: 0.219s


/** wp_postmeta -> wp_postmeta_history */
INSERT
    wp_postmeta_history
SELECT
    PM.*
FROM
    wp_postmeta PM
    LEFT JOIN wp_posts P ON PM.post_id = P.ID
WHERE
    P.post_date < @fecha_inicial
    AND (
        P.post_type = 'tc_tickets_instances'
        OR P.post_type = 'shop_order'
        OR P.post_type = 'product'
        OR P.post_type = 'revision'
        OR P.post_type = 'shop_order_refund'
        OR P.post_type = 'tc_events'
        OR P.post_type = 'pos_temp_register_or'
        OR P.post_type = 'tc_seat_charts'
        OR P.post_type = 'pos_temp_order'
        OR P.post_type = 'shop_coupon'
        OR P.post_type = 'pos_session'
        OR P.post_type = 'pos_receipt'
    )
> Affected rows: 5399918
> Time: 33.586s


DELETE PM
FROM
    wp_postmeta PM
    LEFT JOIN wp_posts P ON PM.post_id = P.ID
WHERE
    P.post_date < @fecha_inicial
    AND (
        P.post_type = 'tc_tickets_instances'
        OR P.post_type = 'shop_order'
        OR P.post_type = 'product'
        OR P.post_type = 'revision'
        OR P.post_type = 'shop_order_refund'
        OR P.post_type = 'tc_events'
        OR P.post_type = 'pos_temp_register_or'
        OR P.post_type = 'tc_seat_charts'
        OR P.post_type = 'pos_temp_order'
        OR P.post_type = 'shop_coupon'
        OR P.post_type = 'pos_session'
        OR P.post_type = 'pos_receipt'
    )
> Affected rows: 5399918
> Time: 33.741s


/** wp_comments -> wp_comments_history */
INSERT
    wp_comments_history
SELECT
    C.*
FROM
    wp_comments C
    LEFT JOIN wp_posts P ON C.comment_post_ID = P.ID
WHERE
    P.post_date < @fecha_inicial
> Affected rows: 233868
> Time: 2.813s


DELETE C
FROM
    wp_comments C
    LEFT JOIN wp_posts P ON C.comment_post_ID = P.ID
WHERE
    P.post_date < @fecha_inicial
> Affected rows: 233868
> Time: 2.024s


/** wp_posts -> wp_posts_history */
INSERT
    wp_posts_history
SELECT
    P.*
FROM
    wp_posts P
WHERE
    P.post_date < @fecha_inicial
    AND (
        P.post_type = 'tc_tickets_instances'
        OR P.post_type = 'shop_order'
        OR P.post_type = 'product'
        OR P.post_type = 'revision'
        OR P.post_type = 'shop_order_refund'
        OR P.post_type = 'tc_events'
        OR P.post_type = 'pos_temp_register_or'
        OR P.post_type = 'tc_seat_charts'
        OR P.post_type = 'pos_temp_order'
        OR P.post_type = 'shop_coupon'
        OR P.post_type = 'pos_session'
        OR P.post_type = 'pos_receipt'
    )
> Affected rows: 311001
> Time: 2.987s


DELETE P
FROM
    wp_posts P
    LEFT JOIN wp_postmeta PM ON P.ID = PM.post_id
WHERE
    P.post_date < @fecha_inicial
    AND (
        P.post_type = 'tc_tickets_instances'
        OR P.post_type = 'shop_order'
        OR P.post_type = 'product'
        OR P.post_type = 'revision'
        OR P.post_type = 'shop_order_refund'
        OR P.post_type = 'tc_events'
        OR P.post_type = 'pos_temp_register_or'
        OR P.post_type = 'tc_seat_charts'
        OR P.post_type = 'pos_temp_order'
        OR P.post_type = 'shop_coupon'
        OR P.post_type = 'pos_session'
        OR P.post_type = 'pos_receipt'
    )
> Affected rows: 311001
> Time: 9.840s


/**********************************
 *
 *   DELETE ORPHAN WITHOUT SAVING
 *
 **********************************/
DELETE TTO
/* TABLE TO OPTIMIZE  */
FROM
    wp_wc_product_meta_lookup AS TTO
    LEFT JOIN wp_posts AS P ON TTO.product_id = P.ID
WHERE
    P.ID IS NULL
> Affected rows: 36533
> Time: 0.431s


DELETE OI,
IM
FROM
    wp_woocommerce_order_items AS OI
    LEFT JOIN wp_woocommerce_order_itemmeta AS IM ON OI.order_item_id = IM.order_item_id
    LEFT JOIN wp_posts AS PM ON OI.order_id = PM.ID
WHERE
    PM.ID IS NULL
> Affected rows: 1911159
> Time: 13.289s


DELETE UM
FROM
    wp_usermeta UM
    LEFT JOIN wp_users U ON UM.user_id = U.ID
WHERE
    U.ID IS NULL
> Affected rows: 60
> Time: 0.574s


/**********************************
 *
 *          TABLE DEFRAG
 *˚
 **********************************/
ALTER TABLE
    wp_posts ENGINE = INNODB
> OK
> Time: 0.475s


ALTER TABLE
    wp_postmeta ENGINE = INNODB
> OK
> Time: 3.600s


ALTER TABLE
    wp_comments ENGINE = INNODB
> OK
> Time: 0.357s


COMMIT
> OK
> Time: 0.133s


